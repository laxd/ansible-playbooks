---

- name: Create database
  shell: influx --execute "CREATE DATABASE {{ influxdb_database }}"
  register: create_db_result
  failed_when: "create_db_result.rc != 0 and (\"unable to parse Basic Auth\" not in create_db_result.stderr)"
  changed_when: "create_db_result.rc == 0"

- name: Set influxdb username/password
  shell: influx --database {{ influxdb_database }} --execute "CREATE USER {{ influxdb_username }} WITH PASSWORD '{{ influxdb_password }}' WITH ALL PRIVILEGES"
  register: create_user_result
  failed_when: "create_user_result.rc != 0 and (\"unable to parse Basic Auth\" not in create_user_result.stderr)"
  changed_when: "create_user_result.rc == 0"

- name: Enable auth
  become: true
  replace:
    dest: /etc/influxdb/influxdb.conf
    regexp: 'auth-enabled = false'
    replace: 'auth-enabled = true'

# Force systemd to reload-daemon
- meta: flush_handlers

- name: "Restart influxdb and grafana"
  become: true
  service:
    name: "{{ item }}"
    state: restarted
    enabled: yes
  with_items:
    - influxdb
    - grafana
